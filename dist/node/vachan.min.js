"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}var vachan={};vachan.Pending=Symbol("Pending"),vachan.Fulfilled=Symbol("Fulfilled"),vachan.Rejected=Symbol("Rejected"),vachan.Macro=Symbol("Macro"),vachan.Micro=Symbol("Micro"),vachan.Sync=Symbol("Sync"),vachan.default_type=vachan.Micro,vachan.realm=require("conciseee")();var recurHandler=function(a,b,c,d){if(null==a)b(a);else if(a===d)c(new TypeError("It cannot return the same Promise"));else if(a instanceof P){var f=!1,g=!1;a.then(function(a){f||g||recurHandler(a,b,c,d),f=!0},function(a){f||g||c(a),g=!0}),vachan.realm.emit("Rechained",a,d)}else if(a instanceof Object||a instanceof Function||"object"===_typeof(a)||"function"==typeof a){var h=!1,i=!1;try{var j=a.then;j!==void 0&&j instanceof Function&&"function"==typeof j?(j.call(a,function(a){h||i||recurHandler(a,b,c,d),h=!0},function(a){h||i||c(a),i=!0}),vachan.realm.emit("Rechained",a,d)):b(a)}catch(a){h||i||c(a)}}else b(a)},handler=function(a,b){return function(c){try{recurHandler(a(c),b.resolve,b.reject,b.cp)}catch(a){b.reject(a)}}},P=function(){function a(b){var c=this,d=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:vachan.default_type;_classCallCheck(this,a),this.async=d,this.type=e,this.state=vachan.Pending,this.value=void 0,this.success_handler=[],this.failure_handler=[],b&&(this.logic=b,this.logic(function(a){return c.resolve(a)},function(a){return c.reject(a)},this)),vachan.realm.emit("Created",this)}return _createClass(a,null,[{key:"resolve",value:function resolve(b){return new a(function(a){return a(b)})}},{key:"reject",value:function reject(b){return new a(function(a,c){return c(b)})}},{key:"all",value:function all(){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return 1==c.length&&Array.isArray(c[0])&&(c=c[0]),new a(function(a,b){var d=0,e=[],f=function(){return d==c.length?a(e):0},g=function(a){d++,e.push(a),f()},h=function(a){return b(a)},i=!0,j=!1,k=void 0;try{for(var l,m,n=c[Symbol.iterator]();!(i=(l=n.next()).done);i=!0)m=l.value,m.then(g,h)}catch(a){j=!0,k=a}finally{try{i||null==n["return"]||n["return"]()}finally{if(j)throw k}}})}},{key:"race",value:function race(){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return 1==c.length&&Array.isArray(c[0])&&(c=c[0]),new a(function(a,b){var d=!1,e=function(b){d||(d=!0,a(b))},f=function(a){return b(a)},g=!0,h=!1,i=void 0;try{for(var j,k,l=c[Symbol.iterator]();!(g=(j=l.next()).done);g=!0)k=j.value,k.then(e,f)}catch(a){h=!0,i=a}finally{try{g||null==l["return"]||l["return"]()}finally{if(h)throw i}}})}},{key:"delay",value:function delay(b,c){return new a(function(a){return setTimeout(function(){return a(b)},c)})}},{key:"vachanify",value:function vachanify(b){return function(){for(var c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];return new a(function(a,c){0<d.length?b.apply(void 0,d.concat([function(b,d){return b?c(b):a(d)}])):b(function(b,d){return b?c(b):a(d)})})}}}]),_createClass(a,[{key:"isFulfilled",value:function isFulfilled(){return this.state===vachan.Fulfilled}},{key:"isRejected",value:function isRejected(){return this.state===vachan.Rejected}},{key:"isPending",value:function isPending(){return this.state===vachan.Pending}},{key:"resolve",value:function resolve(a){var b=this;if(this.state===vachan.Pending){this.state=vachan.Fulfilled,this.value=a;var c=!0,d=!1,e=void 0;try{for(var f,g=function(){var c=f.value;b.queueTask(function(){return c(a)})},h=this.success_handler[Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g()}catch(a){d=!0,e=a}finally{try{c||null==h["return"]||h["return"]()}finally{if(d)throw e}}vachan.realm.emit("Fulfilled",this)}}},{key:"reject",value:function reject(a){var b=this;if(this.state===vachan.Pending){this.state=vachan.Rejected,this.value=a;var c=!0,d=!1,e=void 0;try{for(var f,g=function(){var c=f.value;b.queueTask(function(){return c(a)})},h=this.failure_handler[Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g()}catch(a){d=!0,e=a}finally{try{c||null==h["return"]||h["return"]()}finally{if(d)throw e}}vachan.realm.emit("Rejected",this)}}},{key:"queueTask",value:function queueTask(a){this.async?this.type===vachan.Micro?(process.nextTick(a),vachan.realm.emit("TaskQueued",this,vachan.Micro,a)):this.type===vachan.Macro&&(setTimeout(a,0),vachan.realm.emit("TaskQueued",this,vachan.Macro,a)):(a(),vachan.realm.emit("TaskQueued",this,vachan.Sync,a))}},{key:"then",value:function then(b,c){var d=this;"function"!=typeof b&&(b=void 0),"function"!=typeof c&&(c=void 0);var g=new a,h={resolve:function resolve(a){return g.resolve(a)},reject:function reject(a){return g.reject(a)},cp:g};return this.state===vachan.Fulfilled?(b?this.queueTask(function(){return handler(b,h)(d.value)}):this.queueTask(function(){return g.resolve(d.value)}),vachan.realm.emit("Preresolved",this,g,b)):this.state===vachan.Rejected?(c?this.queueTask(function(){return handler(c,h)(d.value)}):this.queueTask(function(){return g.reject(d.value)}),vachan.realm.emit("Prerejected",this,g,c)):(b?this.success_handler.push(handler(b,h)):this.success_handler.push(h.resolve),c?this.failure_handler.push(handler(c,h)):this.failure_handler.push(h.reject),vachan.realm.emit("Chained",this,g)),g}},{key:"catch",value:function _catch(a){return this.then(void 0,a)}},{key:"finally",value:function _finally(a){return this.then(a,a)}},{key:"delay",value:function delay(b){var c=this;return new a(function(a,d){c.then(function(c){return setTimeout(function(){return a(c)},b)},function(a){return setTimeout(function(){return d(a)},b)})})}}]),a}();vachan.P=P,module.exports.P=vachan.P,module.exports.Macro=vachan.Macro,module.exports.Micro=vachan.Micro;